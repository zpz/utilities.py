#!/bin/bash

# This builds Docker image, starts a container,
# and lands in it for interactive tests.

set -e

# Infer package name:
rm -rf src/*egg-info
proj="$(ls src/)"
if [[ $proj = *' '* ]]; then
    >&2 echo "unable to infer project name"
    exit 1
fi
PROJ=${proj%/}


cat <<EOF >Dockerfile
FROM zppz/py3:22.02.27
USER root

COPY . /src/
WORKDIR  /src

RUN python -m pip install -e .[tests]

USER docker-user
EOF


docker build \
    -f Dockerfile \
    -t ${PROJ}-dev:latest \
    .

rm -f Dockerfile

docker run \
    -it --rm \
    -v $(pwd):/src \
    -e IMAGE_NAME=${PROJ} \
    ${PROJ}-dev:latest \
    bash
