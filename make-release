#!/bin/bash

set -e

TINY=zppz/tiny:21.01.02

branch=$(git branch --show-current)
if [[ ${branch} != master ]] && [[ ${branch} != main ]]; then
    >&2 echo Please switch to branch '"master"' or '"main"' to make a release
    exit 1
fi

PYVER=3.8

docker build \
    --build-arg PYTHON_VERSION=${PYVER} \
    --target release-test \
    -t zpz-release-test:latest \
    .

echo

docker run --rm zpz-release-test:latest \
    py.test \
        --flake8 --mypy --log-cli-level warning \
        --cov=/usr/local/lib/python${PYVER}/site-packages/zpz \
        --cov-fail-under 35 \
        /tmp/zpz-dist/tests

echo

version=$(docker run --rm ${TINY} make-date-version)

docker build \
    --build-arg PYTHON_VERSION=${PYVER} \
    --target release \
    -t zpz-installer:${version} \
    .
docker rmi zpz-release-test:latest


echo
echo Successfully created release zpz-installer:${version}
