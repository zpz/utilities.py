#!/usr/bin/env bash

branch=$(git branch --show-current)
if [[ ${branch} != master ]] && [[ ${branch} != main ]]; then
    >&2 echo Please switch to branch '"master"' or '"main"' to make release
    # exit 1
fi

PYVER=3.8

docker build \
    --build-arg PYTHON_VERSION=${PYVER} \
    --target release-test \
    -t zpz-release-test:latest \
    . || exit 1

echo

docker run --rm zpz-release-test:latest \
    py.test \
        --flake8 --mypy --log-cli-level warning \
        --cov=/usr/local/lib/python${PYVER}/site-packages/zpz \
        --cov-fail-under 35 \
        /tmp/zpz-dist/tests
if [ $? -ne 0 ]; then
    exit 1
fi
echo

version=$(docker run --rm zpz-release-test:latest pip show zpz | grep Version)
version=${version#* }
echo
echo "zpz version: ${version}"
echo


docker build \
    --build-arg PYTHON_VERSION=${PYVER} \
    --target release \
    -t zppz/zpz-installer:${version} \
    . || exit 1
if [[ $? != 0 ]]; then
    docker rmi zpz-release-test:latest
    exit 1
fi
docker rmi zpz-release-test:latest


echo
echo Successfully created release zppz/zpz-installer:${version}
