#!/usr/bin/env bash

if [[ $(git branch --show-current) != master ]]; then
    >&2 echo Please switch to branch '"master"' to make release
    # exit 1
fi

docker build \
    --build-arg PYTHON_VERSION=3.8 \
    --target release-test \
    -t zpz-release-test:latest \
    . || exit 1

docker run --rm zpz-release-test:latest \
    py.test --log-cli-level warning \
    --cov=/usr/local/lib/python3.8/site-packages/zpz \
    --cov-fail-under 30 \
    /zpz-dist/tests
if [ $? -ne 0 ]; then
    docker rmi zpz-release-test:latest
    exit 1
fi


version=$(docker run --rm zpz-release-test:latest pip show zpz | grep Version)
version=${version#* }
echo
echo "zpz version: ${version}"
echo

docker build -t zppz/zpz:${version} - <<EOF
FROM alpine:3

COPY --from=zpz-release-test:latest /zpz-dist /zpz-dist
EOF
if [[ $? != 0 ]]; then
    docker rmi zpz-release-test:latest
    exit 1
fi
docker rmi zpz-release-test:latest


echo
echo Successfully created release zppz/zpz:${version}
